# 락
동시성  
다수의 사용자가 동시에 접근하는 경우가 빈번하게 발생할 때  트랜잭션들이 접근할 수 있는 데이터를 적절히 통제하지 않음녀 데이터 무결성에 문제가 발생할 수 있다.  
그래서 데이터베이스 자워을 잠궈서 하나의 트랜잭션만 접근한다거나, 조건에 따라 읽거나 쓰지 못하게 막아줄 수 있다.  
이러한 행위를 락이라고 부른다.

난관적 락: 안 잠금, 읽는거 ok, 마무리할 때 version확인, 동시성 향상, 비교적 동시성이 덜 일어나 충돌할 가능성이 낮을 때 사용, 충돌이 많이 발생하면 성능저하.
비관적 락: 처음부터 잠금, 읽는거만 가능도 있고, 자기 외에 아무도 못들어옴도 있음, 충돌이 많이 발생할 동시성이 매우 많을 경우 사용, 충돌이 잘 안일어나면 성능 저하.

1. 낙관적 락
    데이터베이스 자원을 잠구지 않는다.  
    대신 데이터를 갱신해야 되는 시점에 데이터가 처음 조회했을 때의 시점에서 변하지 않았다는 것을 바탕으로 실행될지 안될지를 결정하는 방식으로 동시성 문제를 해결한다.

    낙관적 락은 데이터베이스의 기능을 이용해 실제로 데이터의 접근을 막는 것이 아니기 때문에, 서로 다른 트랜잭션의 데이터로의 접근을 막지 않는다.  
    그래서 충돌이 발생하지 않는 상황에 대해서는 좋은 성능을 보여준다. 반면 실제로 충돌이 발생한 상황이라면 해당 충돌을 직접 해소해 주어야 합니다.  
    자바는 예외처리를 하는데 만드는 비용자체가 생각보다 많은 자워을 소모하기 때문에 예외가 발생하는게 성능에 영향을 줄 수 있다.  
    변경사항이 생겼다는 사실을 기록할 컬럼이 추가로 필요하다. 즉 많은 충돌이 발생하면 비용이 아주 많이 든다.
    실제로 충돌이 자주 일어나지 않을거다를 전재인 상황에서 많이 사용한다.

    사용방법:  
    Entity클래스에 @Version을 가진 엔티티를 만든다. 그러면 낙관적 락을 사용한다는 뜻이 된다.  
    트랜잭션이 동시에 발생하면 현재 version을 읽고 트랜잭션이 update를 하려고 하면 version을 보고 현재의 버전과 트랜잭션 시작 시 읽은 버전을 비교하여 일치하면 update를 허용하고 version을 수정한다.  
    동시에 실행된 다른 트랜잭션은 읽기는 기능하지만 update를 하려고 하면 현재 version과 트랜잭션이 시작 시 읽은 version을 확인하면 version이 바뀌어 있어서 충돌이라고 판단하여 update를 막는다.  
    예외발생 OptimisticLockException  
    그리고 개발자가 충돌 발생 시 롤백해서 다시 실행을 한다고 만들어 놓았으면 다시 트랜젝션이 실행되며 version을 읽고 나머지를 순차적으로 실행하고 update시에 version을 확인하면 version이 똑같으니 update를 진행 할 수 있다.  

2. 비관적 락
    비관적 락은 그냥 아싸리 처음부터 다른 트랜잭션의 접근을 막는다.  
    순차적으로 접근하도록 자원을 잠근다.  
    
    종류  
    1. shared lock: 다른 트랜잭션이 읽기는 가능하지만 쓰기는 불가능.
    2. exclusive lock: 다른 트랜잭션이 읽기 쓰기가 불가능하다.

    트랜잭션이 내부에서 lock을 진행하면 트랜잭션이 종료될 때까지 유지된다.  

    비관적 락은 충돌을 방지하기 위해 미리 설정해둠으로 충돌이 일어나지 않는 상황에서도 락이 걸리는 상황이 발생한다.  
    그러면 성능저하가 된다. 또한 교착상태의 위험성도 존재한다.  
    a 트랜잭션이 다른 b 트랜잭션이 필요한데 b 트랜잭션도 a 트랜잭션이 필요하면 서로 락이 걸려있어 참조도 못해 멈추어버린다.  
    그래서 비관적 락은 어느 시점에 언제 어떤 이유로 걸지 잘 판단해서 작성하는 것이 중요하다.  

    사용방법:  
    레포지토리에 @Lock을 건다.  
    ```java
    @Lock(LockModeType.PESSIMISTIC_READ) //비관적 락을 건다. 읽기만 가능한
    @Query("SELECT i FROM Item i WHERE i.id = :id")
    Optional<Item> findItemForShare(
        @Param("id") Long id
    );
    @Lock(LockModeType.PESSIMISTIC_WRITE) //
    @Query("SELECT i FROM Item i WHERE i.id = :id")
    Optional<Item> findItemForUpdate(
        @Param("id") Long id
    );
    ```



